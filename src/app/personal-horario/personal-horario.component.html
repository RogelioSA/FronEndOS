<div class="container-fluid">
  <div class="row mt-3 justify-content-md-center mb-4">
    <div class="col-12">
      <h3>Personal Horario Mantenimiento</h3>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="row mt-2 justify-content-md-center mb-4 items-center">
    <div class="col-4">
      <dx-select-box
        displayExpr="cOrdenInterna"
        valueExpr="nCodigo"
        [dataSource]="ordenes"
        [(value)]="ordenCombo"
        (onValueChanged)="onOrdenChange($event)"
        placeholder="Selecciona Orden de Trabajo">
      </dx-select-box>
    </div>

    <div class="col-2">
      <dx-date-box 
        placeholder="Fecha Desde" 
        [(value)]="fechaDesde"
        displayFormat="dd/MM/yyyy" 
        type="date"
        [readOnly]="true">
      </dx-date-box>
    </div>

    <div class="col-2">
      <dx-date-box 
        placeholder="Fecha Hasta" 
        [(value)]="fechaHasta"
        displayFormat="dd/MM/yyyy" 
        type="date"
        [readOnly]="true">
      </dx-date-box>
    </div>

    <div class="col-2 text-end">
      <dx-button text="Buscar" stylingMode="contained" type="default"
                 icon="fa-solid fa-magnifying-glass" [width]="120"
                 (onClick)="onBuscar()">
      </dx-button>
    </div>
  </div>

  <div class="row g-1 mt-2 justify-content-md-center mb-4">
    <!-- PERSONAL DISPONIBLE -->
    <div class="col-3">
      <h5>Personal disponible</h5>

      <!-- Mensaje si no hay orden/fechas -->
      <div *ngIf="!ordenCombo || !fechaDesde || !fechaHasta"
           class="alert alert-warning text-center py-3">
        Selecciona una orden de trabajo y presiona Buscar
      </div>

      <!-- Grid disponible -->
      <dx-data-grid *ngIf="ordenCombo && fechaDesde && fechaHasta && columnasFechas.length > 0"
        [dataSource]="personalDisponibles"
        keyExpr="nEmpleado"
        [showBorders]="true"
        [selection]="{ mode: 'multiple' }"
        (onSelectionChanged)="onDisponiblesSelectionChanged($event)">
        <dxi-column type="selection" width="50"></dxi-column>
        <dxi-column dataField="cEmpleado" caption="Nombre"></dxi-column>
      </dx-data-grid>

      <div class="mt-2 flex gap-2 justify-end" *ngIf="ordenCombo && fechaDesde && fechaHasta && columnasFechas.length > 0">
        <dx-button text="Asignar seleccionados"
                   [disabled]="!hayDisponiblesSeleccionados"
                   (onClick)="agregarSeleccionados()">
        </dx-button>
      </div>
    </div>

    <!-- PERSONAL ASIGNADO -->
    <div class="col-9">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <!-- COMENTADO: Ya no se usa asignación de horario manualmente
        <div class="flex items-center gap-2">
          <span>Asignar a seleccionados:</span>
          <dx-select-box
            [dataSource]="horarios" displayExpr="cNombre" valueExpr="nCodigo"
            [(ngModel)]="horarioParaAsignar"
            placeholder="Seleccionar horario">
          </dx-select-box>
          <dx-button text="Asignar"
            [disabled]="!horarioParaAsignar || seleccionadosMain.length===0 || !ordenCombo || !fechaDesde || !fechaHasta"
            (onClick)="asignarHorarioASeleccionados()">
          </dx-button>
        </div>
        -->

        <div></div> <!-- Espaciador -->

        <div class="flex gap-2"> 
          <dx-button text="Desasignar seleccionados" type="danger"
            [disabled]="seleccionadosMain.length===0 || !ordenCombo || !fechaDesde || !fechaHasta"
            (onClick)="desasignarSeleccionados()">
          </dx-button>
          <dx-button text="Guardar" stylingMode="contained"
            [disabled]="desactivarBotonGuardar || !ordenCombo || !fechaDesde || !fechaHasta"
            (onClick)="enviarPersonalHorario()">
          </dx-button>
        </div>
      </div>

      <!-- Mensaje si no hay orden/fechas -->
      <div *ngIf="!ordenCombo || !fechaDesde || !fechaHasta"
           class="alert alert-warning text-center py-3">
        Selecciona una orden de trabajo y presiona Buscar
      </div>

      <!-- Grid principal -->
      <dx-data-grid *ngIf="ordenCombo && fechaDesde && fechaHasta && columnasFechas.length > 0"
        [dataSource]="personalHorarios"
        keyExpr="nEmpleado"
        [showBorders]="true"
        [allowColumnResizing]="true"
        [columnAutoWidth]="true"
        [selection]="{ mode: 'multiple' }"
        (onSelectionChanged)="onMainGridSelectionChanged($event)">
    
        <dxi-column dataField="cEmpleado" caption="Nombres" [allowEditing]="false"></dxi-column>
    
        <!-- Las columnas de horario con LOOKUP automático -->
        <ng-container *ngFor="let col of columnasFechas">
          <dxi-column 
            [dataField]="col.field" 
            [caption]="col.caption" 
            [width]="140" 
            alignment="center"
            [allowEditing]="false">
            
            <!-- LOOKUP: Convierte el ID del horario en nombre automáticamente -->
            <dxo-lookup 
              [dataSource]="horarios"
              displayExpr="cNombre"
              valueExpr="nCodigo">
            </dxo-lookup>
          </dxi-column>
        </ng-container>
      </dx-data-grid>
    </div>
  </div>
</div>

<!-- Message box -->
<div id="messageBox" style="display:none; position:fixed; right:20px; bottom:20px; background:#d4edda; color:#155724; padding:10px; border-radius:6px; font-weight:600;"></div>