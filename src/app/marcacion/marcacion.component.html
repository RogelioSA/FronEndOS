<div class="marcacion-container h-screen">
    <div class="row">
        <div class="col-12 mb-4 text-center">
            <h2 class="text-center">Marcación</h2>
            
            <!-- Contenedor de video/cámara -->
            <div class="video-container" *ngIf="!showStatusCard">
                <video #videoElement autoplay playsinline class="video-feed"></video>
                <canvas #canvasElement class="d-none"></canvas>
            </div>

            <!-- Mostrar imagen capturada cuando se procesa -->
            <div *ngIf="capturedImage && !showStatusCard" class="captured-image-container">
                <img [src]="capturedImage" alt="Foto capturada" class="captured-image">
            </div>

            <app-analog-clock #reloj *ngIf="!showStatusCard"></app-analog-clock>
            <h3 *ngIf="!showStatusCard">({{ fecha }})</h3>
            <h3 *ngIf="!showStatusCard">{{ claims.cApPater | uppercase }}, {{ claims.cNombres | uppercase }}</h3>
            <p *ngIf="!showStatusCard" class="coordinates-text">{{ coordinates }}</p>
        </div>

        <!-- Botón de marcar asistencia -->
        <div class="col-12 text-center" *ngIf="!showStatusCard">
            <dx-button text="Marcar asistencia"
                    stylingMode="contained"
                    type="default"
                    [width]="250"
                    icon="fa-solid fa-check"
                    [disabled]="isProcessing"
                    (onClick)="marcar()">
            </dx-button>
        </div>

        <!-- Card de estado del proceso -->
        <div class="col-12" *ngIf="showStatusCard">
            <div class="status-card">
                <div class="status-header">
                    <i class="fa-solid fa-exclamation-triangle warning-icon" *ngIf="!successMessage"></i>
                    <i class="fa-solid fa-check-circle success-icon" *ngIf="successMessage"></i>
                    
                    <h4 *ngIf="!successMessage">Está a punto de registrar su marcación.</h4>
                    <h4 *ngIf="!successMessage">¿Usted está seguro? <i class="fa-solid fa-question-circle"></i></h4>
                    
                    <h4 *ngIf="successMessage" class="success-title">{{ successMessage }}</h4>
                </div>

                <div class="status-info" *ngIf="!successMessage">
                    <p class="info-text">
                        Recuerde que la imagen de su rostro debe aparecer en la foto y 
                        debe de estar bien centrado, no se considerará una marca válida si no 
                        se ve su rostro.
                    </p>
                </div>

                <div class="status-table">
                    <div class="status-row">
                        <div class="status-label">Operación</div>
                        <div class="status-value">Estado</div>
                    </div>
                    
                    <!-- Paso 1: Subiendo foto -->
                    <div class="status-row" [ngClass]="{
                        'status-error': statusSteps.uploadingPhoto === 'error', 
                        'status-success': statusSteps.uploadingPhoto === 'success'
                    }">
                        <div class="status-label">Subiendo foto</div>
                        <div class="status-icon">
                            <i class="fa-solid fa-circle-xmark" *ngIf="statusSteps.uploadingPhoto === 'error'"></i>
                            <i class="fa-solid fa-circle-check" *ngIf="statusSteps.uploadingPhoto === 'success'"></i>
                            <i class="fa-regular fa-clock" *ngIf="statusSteps.uploadingPhoto === 'pending'"></i>
                        </div>
                    </div>
                    
                    <!-- Paso 2: Registrando asistencia -->
                    <div class="status-row" [ngClass]="{
                        'status-error': statusSteps.registeringAttendance === 'error', 
                        'status-success': statusSteps.registeringAttendance === 'success'
                    }">
                        <div class="status-label">Registrando asistencia</div>
                        <div class="status-icon">
                            <i class="fa-solid fa-circle-xmark" *ngIf="statusSteps.registeringAttendance === 'error'"></i>
                            <i class="fa-solid fa-circle-check" *ngIf="statusSteps.registeringAttendance === 'success'"></i>
                            <i class="fa-regular fa-clock" *ngIf="statusSteps.registeringAttendance === 'pending'"></i>
                        </div>
                    </div>
                </div>

                <!-- Mensaje de error -->
                <div class="error-message" *ngIf="hasError">
                    <p>{{ errorMessage || 'Hubo un error en el registro de la marcación, contacte al administrador del sistema.' }}</p>
                </div>

                <!-- Mensaje de éxito -->
                <div class="success-message" *ngIf="successMessage">
                    <p>Su asistencia ha sido registrada exitosamente. Puede cerrar esta ventana.</p>
                </div>

                <div class="button-container">
                    <dx-button text="Cerrar"
                            stylingMode="contained"
                            [type]="successMessage ? 'success' : 'danger'"
                            [width]="120"
                            (onClick)="cerrarStatus()">
                    </dx-button>
                </div>
            </div>
        </div>
    </div>
</div>