<div class="container-fluid">
    <!-- Leaflet CSS y JS desde CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <div class="row g-1 mt-2 justify-content-md-center mb-4 align-items-end">
        <div class="col-3">
            <div class="dx-field-label">Orden de Trabajo:</div>
            <div class="dx-field-value">
                <dx-select-box
                    [dataSource]="ordenesTrabajo"
                    displayExpr="cOrdenInterna"
                    valueExpr="id"
                    [(value)]="ordenTrabajoSeleccionada"
                    placeholder="Seleccione una orden de trabajo"
                    [width]="'100%'"
                ></dx-select-box>
            </div>
        </div>
        <div class="col-3">
            <div class="dx-field-label">Fecha Inicial</div>
            <div class="dx-field-value">
                <dx-date-box type="date" [value]="now" [(ngModel)]="fechaInicial" name="fechaInicial"
                    [displayFormat]="'dd/MM/yyyy'" [inputAttr]="{ 'aria-label': 'Date' }">
                </dx-date-box>
            </div>
        </div>
        <div class="col-3">
            <div class="dx-field-label">Fecha Final</div>
            <div class="dx-field-value">
                <dx-date-box type="date" [value]="now" [(ngModel)]="fechaFinal" name="fechaFinal"
                    [displayFormat]="'dd/MM/yyyy'" [inputAttr]="{ 'aria-label': 'Date' }">
                </dx-date-box>
            </div>
        </div>
        <div class="col-auto pb-2 pb-md-0">
            <div class="form-check">
                <input
                    class="form-check-input"
                    type="checkbox"
                    id="verTodoCheck"
                    [(ngModel)]="verTodo"
                    (change)="onVerTodoChanged()">
                <label class="form-check-label" for="verTodoCheck">
                    Ver todo
                </label>
            </div>
        </div>
        <div class="col-auto text-end pb-2 pb-md-0">
            <dx-button text="Buscar" stylingMode="contained" type="default" [width]="120"
                icon="fa-solid fa-magnifying-glass" (onClick)="buscar()">
            </dx-button>
        </div>
    </div>

    <div class="row g-1 mt-2 justify-content-md-center mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">Reporte de marcaciones</h3>
                <dx-button
                    text="Descargar Excel"
                    stylingMode="contained"
                    type="success"
                    [width]="150"
                    icon="fa-solid fa-file-excel"
                    (onClick)="descargarExcel()"
                    [disabled]="datosReporte.length === 0"
                ></dx-button>
            </div>

            <div class="table-responsive" style="overflow-x: auto; max-height: 600px;">
                <table class="table table-bordered table-hover" style="font-size: 12px;">
                    <thead class="table-dark" style="position: sticky; top: 0; z-index: 10;">
                        <tr>
                            <th rowspan="2" class="align-middle text-center" style="min-width: 100px; position: sticky; left: 0; background-color: #212529; z-index: 11;">DNI</th>
                            <th rowspan="2" class="align-middle text-center" style="min-width: 250px; position: sticky; left: 100px; background-color: #212529; z-index: 11;">PERSONAL</th>

                            <!-- Modo normal: mostrar solo E y S -->
                            <ng-container *ngIf="!verTodo">
                                <th *ngFor="let col of columnasdinamicas" colspan="2" class="text-center"
                                    [ngClass]="{'table-info': col.diaSemana === 'SÁB', 'table-warning': col.diaSemana === 'DOM'}">
                                    <div><strong>{{ col.diaSemana }}</strong> {{ col.fechaDisplay }}</div>
                                </th>
                            </ng-container>

                            <!-- Modo extendido: mostrar E, SR, ER, S, D -->
                            <ng-container *ngIf="verTodo">
                                <th *ngFor="let col of columnasdinamicas" colspan="5" class="text-center"
                                    [ngClass]="{'table-info': col.diaSemana === 'SÁB', 'table-warning': col.diaSemana === 'DOM'}">
                                    <div><strong>{{ col.diaSemana }}</strong> {{ col.fechaDisplay }}</div>
                                </th>
                            </ng-container>
                        </tr>
                        <tr>
                            <!-- Modo normal -->
                            <ng-container *ngIf="!verTodo">
                                <ng-container *ngFor="let col of columnasdinamicas">
                                    <th class="text-center" style="min-width: 60px;"
                                        [ngClass]="{'table-info': col.diaSemana === 'SÁB', 'table-warning': col.diaSemana === 'DOM'}">E</th>
                                    <th class="text-center" style="min-width: 60px;"
                                        [ngClass]="{'table-info': col.diaSemana === 'SÁB', 'table-warning': col.diaSemana === 'DOM'}">S</th>
                                </ng-container>
                            </ng-container>

                            <!-- Modo extendido -->
                            <ng-container *ngIf="verTodo">
                                <ng-container *ngFor="let col of columnasdinamicas">
                                    <th class="text-center" style="min-width: 60px;"
                                        [ngClass]="{'table-info': col.diaSemana === 'SÁB', 'table-warning': col.diaSemana === 'DOM'}"
                                        title="Entrada">E</th>
                                    <th class="text-center" style="min-width: 60px;"
                                        [ngClass]="{'table-info': col.diaSemana === 'SÁB', 'table-warning': col.diaSemana === 'DOM'}"
                                        title="Salida Refrigerio">SR</th>
                                    <th class="text-center" style="min-width: 60px;"
                                        [ngClass]="{'table-info': col.diaSemana === 'SÁB', 'table-warning': col.diaSemana === 'DOM'}"
                                        title="Entrada Refrigerio">ER</th>
                                    <th class="text-center" style="min-width: 60px;"
                                        [ngClass]="{'table-info': col.diaSemana === 'SÁB', 'table-warning': col.diaSemana === 'DOM'}"
                                        title="Salida">S</th>
                                    <th class="text-center" style="min-width: 60px;"
                                        [ngClass]="{'table-info': col.diaSemana === 'SÁB', 'table-warning': col.diaSemana === 'DOM'}"
                                        title="Desconocido">D</th>
                                </ng-container>
                            </ng-container>
                        </tr>
                    </thead>
                    <tbody>
                        <ng-container *ngFor="let grupo of datosAgrupados">
                            <tr class="orden-row">
                                <td [attr.colspan]="calcularColspan()" class="fw-semibold">{{ grupo.orden }}</td>
                            </tr>
                            <tr *ngFor="let empleado of grupo.empleados">
                                <td class="text-center align-middle" style="position: sticky; left: 0; background-color: white; font-weight: 500;">
                                    {{ empleado.dni }}
                                </td>
                                <td class="align-middle" style="position: sticky; left: 100px; background-color: white; font-weight: 500;">
                                    {{ empleado.personal }}
                                </td>

                            <!-- Modo normal: E y S -->
                            <ng-container *ngIf="!verTodo">
                                <ng-container *ngFor="let col of columnasdinamicas">
                                    <td class="text-center align-middle celda-clickeable"
                                        [ngClass]="{
                                            'bg-danger text-white': esTardanza(empleado, col.fecha, 0),
                                            'bg-light': col.diaSemana === 'SÁB' || col.diaSemana === 'DOM',
                                            'tiene-datos': obtenerMarcacionPorTipo(empleado, col.fecha, 0)
                                        }"
                                        (click)="onCellClick(empleado, col.fecha, 0)"
                                        style="cursor: pointer;">
                                        {{ obtenerMarcacionPorTipo(empleado, col.fecha, 0) }}
                                    </td>
                                    <td class="text-center align-middle celda-clickeable"
                                        [ngClass]="{'bg-light': col.diaSemana === 'SÁB' || col.diaSemana === 'DOM',
                                                    'tiene-datos': obtenerMarcacionPorTipo(empleado, col.fecha, 1)}"
                                        (click)="onCellClick(empleado, col.fecha, 1)"
                                        style="cursor: pointer;">
                                        {{ obtenerMarcacionPorTipo(empleado, col.fecha, 1) }}
                                    </td>
                                </ng-container>
                            </ng-container>

                            <!-- Modo extendido: E, SR, ER, S, D -->
                            <ng-container *ngIf="verTodo">
                                <ng-container *ngFor="let col of columnasdinamicas">
                                    <!-- Entrada (0) -->
                                    <td class="text-center align-middle celda-clickeable"
                                        [ngClass]="{
                                            'bg-danger text-white': esTardanza(empleado, col.fecha, 0),
                                            'bg-light': col.diaSemana === 'SÁB' || col.diaSemana === 'DOM',
                                            'tiene-datos': obtenerMarcacionPorTipo(empleado, col.fecha, 0)
                                        }"
                                        (click)="onCellClick(empleado, col.fecha, 0)"
                                        style="cursor: pointer;">
                                        {{ obtenerMarcacionPorTipo(empleado, col.fecha, 0) }}
                                    </td>

                                    <!-- Salida Refrigerio (2) -->
                                    <td class="text-center align-middle celda-clickeable"
                                        [ngClass]="{'bg-light': col.diaSemana === 'SÁB' || col.diaSemana === 'DOM',
                                                    'tiene-datos': obtenerMarcacionPorTipo(empleado, col.fecha, 2)}"
                                        (click)="onCellClick(empleado, col.fecha, 2)"
                                        style="cursor: pointer;">
                                        {{ obtenerMarcacionPorTipo(empleado, col.fecha, 2) }}
                                    </td>

                                    <!-- Entrada Refrigerio (3) -->
                                    <td class="text-center align-middle celda-clickeable"
                                        [ngClass]="{'bg-light': col.diaSemana === 'SÁB' || col.diaSemana === 'DOM',
                                                    'tiene-datos': obtenerMarcacionPorTipo(empleado, col.fecha, 3)}"
                                        (click)="onCellClick(empleado, col.fecha, 3)"
                                        style="cursor: pointer;">
                                        {{ obtenerMarcacionPorTipo(empleado, col.fecha, 3) }}
                                    </td>

                                    <!-- Salida (1) -->
                                    <td class="text-center align-middle celda-clickeable"
                                        [ngClass]="{'bg-light': col.diaSemana === 'SÁB' || col.diaSemana === 'DOM',
                                                    'tiene-datos': obtenerMarcacionPorTipo(empleado, col.fecha, 1)}"
                                        (click)="onCellClick(empleado, col.fecha, 1)"
                                        style="cursor: pointer;">
                                        {{ obtenerMarcacionPorTipo(empleado, col.fecha, 1) }}
                                    </td>

                                    <!-- Desconocido (99) -->
                                    <td class="text-center align-middle celda-clickeable"
                                        [ngClass]="{'bg-light': col.diaSemana === 'SÁB' || col.diaSemana === 'DOM',
                                                    'bg-warning': obtenerMarcacionPorTipo(empleado, col.fecha, 99),
                                                    'tiene-datos': obtenerMarcacionPorTipo(empleado, col.fecha, 99)}"
                                        (click)="onCellClick(empleado, col.fecha, 99)"
                                        style="cursor: pointer;">
                                        {{ obtenerMarcacionPorTipo(empleado, col.fecha, 99) }}
                                    </td>
                                </ng-container>
                            </ng-container>
                        </tr>
                        </ng-container>
                        <tr *ngIf="datosReporte.length === 0">
                            <td [attr.colspan]="calcularColspan()" class="text-center text-muted">
                                No hay datos para mostrar en el rango de fechas seleccionado
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="messageBox"
                style="display: none; background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-top: 10px; font-weight: bold;">
            </div>

            <!-- Modal de detalle de marcación -->
            <div class="modal-backdrop" *ngIf="mostrarModal" (click)="cerrarModal()"></div>
            <div class="modal-detalle" *ngIf="mostrarModal && detalleMarcacion">
                <div class="modal-content-detalle" (click)="$event.stopPropagation()">
                    <div class="modal-header-detalle">
                        <h5 class="modal-title">Marcacion: {{ detalleMarcacion.fechaJornal }}   Evento: {{ detalleMarcacion.tipoEvento }}</h5>
                        <button type="button" class="btn-close-detalle" (click)="cerrarModal()">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>

                    <div class="modal-body-detalle">
                        <div class="detalle-layout">
                            <div class="detalle-col detalle-info">
                                <div class="info-line stacked">
                                    <span class="info-label">Fecha marcación:</span>
                                    <span class="info-value">{{ detalleMarcacion.fecha }}</span>
                                </div>
                                <!-- <div class="info-line stacked">
                                    <span class="info-label">Fecha registro:</span>
                                    <span class="info-value">{{ detalleMarcacion.fecha }}</span>
                                </div> -->
                                <div class="info-line stacked">
                                    <span class="info-label">Jornal:</span>
                                    <span class="info-value">{{ detalleMarcacion.fechaJornal }}</span>
                                </div>
                                <div class="info-line stacked">
                                    <span class="info-label">Regularizado?:</span>
                                    <span class="info-value">NO</span>
                                </div>
                                <div class="info-line stacked">
                                    <span class="info-label">Usuario:</span>
                                    <span class="info-value">{{ detalleMarcacion.personal }}</span>
                                </div>
                                <div class="info-line stacked">
                                    <span class="info-label">Aplicación:</span>
                                    <span class="info-value">Web / Mobile</span>
                                </div>
                                <!-- <div class="info-line stacked">
                                    <span class="info-label">Tipo de Evento:</span>
                                    <span class="info-value">{{ detalleMarcacion.tipoEvento }}</span>
                                </div> -->
                                <!-- <div class="info-line stacked">
                                    <span class="info-label">Hora Programada:</span>
                                    <span class="info-value">{{ detalleMarcacion.horaProgramada }}</span>
                                </div> -->
                                <div class="info-line stacked">
                                    <span class="info-label">Tardanza:</span>
                                    <span class="info-value" [ngClass]="{'text-danger fw-bold': detalleMarcacion.esTardanza}">
                                        {{ detalleMarcacion.esTardanza ? 'SÍ' : 'NO' }}
                                        <span *ngIf="detalleMarcacion.esTardanza"> ({{ detalleMarcacion.diferenciaMinutos }} min)</span>
                                    </span>
                                </div>

                                <div class="d-grid">
                                    <button
                                        type="button"
                                        class="btn btn-warning btn-regularizar"
                                        (click)="iniciarRegularizacion()"
                                        *ngIf="!editandoMarcacion"
                                    >
                                        REGULARIZAR
                                    </button>
                                </div>

                                <ng-container *ngIf="editandoMarcacion" [ngTemplateOutlet]="regularizacionForm"></ng-container>
                            </div>

                            <div class="detalle-col detalle-extra">
                                <div class="imagen-section">
                                    <div class="section-title">Rostro</div>
                                    <img *ngIf="rostroUrl" [src]="rostroUrl" alt="Rostro de marcación" class="rostro-imagen">
                                    <div class="imagen-placeholder" *ngIf="!rostroUrl">
                                        Imagen no disponible
                                    </div>
                                </div>

                                <div class="ubicacion-section">
                                    <div class="info-line">
                                        <span class="info-label">Ubicación:</span>
                                        <ng-container *ngIf="detalleMarcacion.latitud && detalleMarcacion.longitud; else sinCoordenadas">
                                            <a [href]="detalleMarcacion.linkGoogleMaps" target="_blank" class="link-ubicacion">
                                                <i class="fa-solid fa-map-marker-alt"></i>
                                                {{ detalleMarcacion.latitud }}, {{ detalleMarcacion.longitud }}
                                            </a>
                                        </ng-container>
                                        <ng-template #sinCoordenadas>
                                            <span class="info-value text-muted">Sin coordenadas disponibles</span>
                                        </ng-template>
                                    </div>

                                    <div class="mapa-wrapper" *ngIf="detalleMarcacion.latitud && detalleMarcacion.longitud">
                                        <div id="mapaMarcacion" class="mapa-container"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer-detalle">
                        <button type="button" class="btn btn-light btn-cerrar" (click)="cerrarModal()">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal para regularización desde celdas vacías -->
            <div class="modal-backdrop" *ngIf="mostrarRegularizacionNueva" (click)="cerrarRegularizacionNueva()"></div>
            <div class="modal-detalle" *ngIf="mostrarRegularizacionNueva">
                <div class="modal-content-detalle" (click)="$event.stopPropagation()">
                    <div class="modal-header-detalle">
                        <h5 class="modal-title">Regularizar</h5>
                        <button type="button" class="btn-close-detalle" (click)="cerrarRegularizacionNueva()">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>

                    <div class="modal-body-detalle">
                        <ng-template [ngTemplateOutlet]="regularizacionForm"></ng-template>
                    </div>

                    <div class="modal-footer-detalle">
                        <button type="button" class="btn btn-light btn-cerrar" (click)="cerrarRegularizacionNueva()">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>

            <ng-template #regularizacionForm>
                <div class="regularizacion-form">
                    <div class="info-line stacked">
                        <span class="info-label">Jornal:</span>
                        <input
                            type="date"
                            class="form-control"
                            [(ngModel)]="regularizacion.jornal"
                        />
                    </div>

                    <div class="info-line stacked">
                        <span class="info-label">Evento:</span>
                        <select class="form-select" [(ngModel)]="regularizacion.evento">
                            <option *ngFor="let evento of eventosMarcacion" [ngValue]="evento.id">
                                {{ evento.nombre }}
                            </option>
                        </select>
                    </div>

                    <div class="info-line stacked">
                        <span class="info-label">Orden de Trabajo:</span>
                        <dx-select-box
                            [dataSource]="ordenesTrabajo"
                            displayExpr="cOrdenInterna"
                            valueExpr="id"
                            [(value)]="regularizacion.ordenTrabajoId"
                            placeholder="Seleccione una orden de trabajo"
                            [width]="'100%'"
                        ></dx-select-box>
                    </div>

                    <div class="info-line stacked">
                        <span class="info-label">Hora:</span>
                        <input
                            type="time"
                            class="form-control"
                            [(ngModel)]="regularizacion.hora"
                            placeholder="00:00"
                        />
                    </div>

                    <div class="regularizacion-actions">
                        <button type="button" class="btn btn-primary" (click)="regularizarMarcacion()">
                            Guardar
                        </button>
                        <button type="button" class="btn btn-secondary" (click)="cancelarRegularizacion()">
                            Cancelar
                        </button>
                    </div>
                </div>
            </ng-template>

            <block-ui></block-ui>
        </div>
    </div>
</div>
