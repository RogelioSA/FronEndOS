<div class="container-fluid px-4 py-3">
  <div class="row">
    <div class="col-12">
      <!-- Header Section -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h4 class="mb-1 fw-semibold text-dark">Personal</h4>
          <p class="text-muted small mb-0">Gestión y mantenimiento de personal</p>
        </div>
      </div>

      <!-- Botón Subida Masiva -->
      <div class="mb-3">
        <button 
          class="btn btn-success btn-sm" 
          (click)="abrirSubidaMasiva()"
        >
          <i class="fas fa-file-excel me-2"></i>Subida Masiva
        </button>
      </div>

      <!-- Grid Container -->
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <dx-data-grid
            id="gridContainer"
            [dataSource]="personal"
            keyExpr="nCodigo"
            [showBorders]="false"
            (onRowUpdating)="actualizar($event)"
            (onRowInserted)="insertar($event)"
            (onRowRemoved)="eliminar($event)"
            [rowAlternationEnabled]="true"
            [showColumnLines]="false"
            [showRowLines]="true"
            [allowColumnResizing]="true"
            [columnAutoWidth]="true"
            [hoverStateEnabled]="true"
          >
            <dxo-paging [pageSize]="50"></dxo-paging>
            <dxo-pager
              [visible]="true"
              [showPageSizeSelector]="true"
              [allowedPageSizes]="[50, 100, 150, 200]"
              [showInfo]="true"
              infoText="Mostrando {0}-{1} de {2} registros"
            ></dxo-pager>

            <dxo-search-panel [visible]="false"></dxo-search-panel>
            <dxo-filter-row [visible]="false"></dxo-filter-row>
            <dxo-header-filter [visible]="true"></dxo-header-filter>

            <dxo-editing
              mode="popup"
              [allowUpdating]="true"
              [allowAdding]="true"
              [allowDeleting]="true"
              [selectTextOnEditStart]="true"
              startEditAction="click"
              use-icons="true"
            >
              <dxo-popup
                title="Gestión de Personal"
                [showTitle]="true"
                [width]="950"
                [height]="650"
              >
                <dxo-position my="center" at="center"></dxo-position>
              </dxo-popup>
            </dxo-editing>

            <dxo-export [enabled]="true" [allowExportSelectedData]="true"></dxo-export>
            <dxo-selection mode="multiple" [showCheckBoxesMode]="'always'"></dxo-selection>

            <dxi-column 
              dataField="nCodigo" 
              caption="ID" 
              [width]="80" 
              [allowEditing]="false" 
              alignment="center"
              cssClass="text-muted small"
            ></dxi-column>

            <dxi-column dataField="cNombres" caption="Nombres" [minWidth]="150">
              <dxi-validation-rule type="required"></dxi-validation-rule>
            </dxi-column>

            <dxi-column dataField="cApPater" caption="Ap. Paterno" [minWidth]="120">
              <dxi-validation-rule type="required"></dxi-validation-rule>
            </dxi-column>

            <dxi-column dataField="cApMater" caption="Ap. Materno" [minWidth]="120">
              <dxi-validation-rule type="required"></dxi-validation-rule>
            </dxi-column>

            <dxi-column dataField="cDNI" caption="DNI" [width]="100" dataType="number" [editorOptions]="{ format: '#'}" alignment="center">
              <dxi-validation-rule type="required"></dxi-validation-rule>
              <dxi-validation-rule
                type="stringLength"
                [min]="8"
                [max]="8"
                message="El DNI debe tener 8 dígitos."
              ></dxi-validation-rule>
            </dxi-column>

            <dxi-column dataField="cCorreo" caption="Correo Electrónico" [minWidth]="200">
              <dxi-validation-rule type="required"></dxi-validation-rule>
              <dxi-validation-rule type="email"></dxi-validation-rule>
            </dxi-column>

            <dxi-column dataField="cCelular" caption="Celular" [width]="110" dataType="number" [editorOptions]="{ format: '#'}" alignment="center">
              <dxi-validation-rule type="required"></dxi-validation-rule>
            </dxi-column>

            <dxi-column dataField="cSexo" caption="Sexo" [width]="90" alignment="center">
              <dxo-lookup 
                [dataSource]="sexo" 
                displayExpr="cNombre" 
                valueExpr="nCodigo">
              </dxo-lookup>
              <dxi-validation-rule type="required"></dxi-validation-rule>
            </dxi-column>

            <dxi-column dataField="dFechaNacimiento" caption="F. Nacimiento" dataType="date" [width]="120" alignment="center">
              <dxi-validation-rule type="required"></dxi-validation-rule>
            </dxi-column>

            <dxi-column dataField="nLicenciaCategoria" caption="Licencia" [width]="100" alignment="center">
              <dxo-lookup 
                [dataSource]="licencias" 
                displayExpr="cNombre" 
                valueExpr="nCodigo">
              </dxo-lookup>
              <dxi-validation-rule type="required"></dxi-validation-rule>
            </dxi-column>

            <dxi-column dataField="nDocumentoIdentidadTipo" caption="Tipo Doc." [width]="100">
              <dxo-lookup 
                [dataSource]="documentoTipos" 
                displayExpr="cNombre" 
                valueExpr="nCodigo">
              </dxo-lookup>
              <dxi-validation-rule type="required"></dxi-validation-rule>
            </dxi-column>

            <dxi-column dataField="nDistritoId" caption="Distrito" [width]="130">
              <dxo-lookup 
                [dataSource]="distritos" 
                displayExpr="cNombre" 
                valueExpr="nCodigo">
              </dxo-lookup>
              <dxi-validation-rule type="required"></dxi-validation-rule>
            </dxi-column>

            <dxi-column dataField="lEstado" caption="Estado" alignment="center" [width]="90">
              <dxo-lookup 
                [dataSource]="[{id: true, nombre: 'Activo'}, {id: false, nombre: 'Inactivo'}]" 
                displayExpr="nombre" 
                valueExpr="id">
              </dxo-lookup>
            </dxi-column>

            <dxi-column 
              type="buttons" 
              [width]="120" 
              alignment="center"
              caption="Acciones"
              [fixed]="true"
              fixedPosition="right"
            >
              <dxi-button name="edit" icon="edit" hint="Editar" cssClass="text-primary"></dxi-button>
              <dxi-button name="delete" icon="trash" hint="Eliminar" cssClass="text-danger"></dxi-button>
              <dxi-button name="person" icon="group" hint="Asignar Personal" [onClick]="asignarPersonal.bind(this)"></dxi-button>
            </dxi-column>
          </dx-data-grid>
        </div>
      </div>

    </div>
  </div>

  <block-ui></block-ui>
</div>

<!-- Popup Asignar Personal -->
<dx-popup
  [(visible)]="popupVisible"
  [width]="750"
  [height]="'auto'"
  [maxHeight]="'90vh'"
  [showTitle]="true"
  title="Asignación de Personal"
  [dragEnabled]="true"
  [closeOnOutsideClick]="false"
  [showCloseButton]="true"
>
  <div class="p-4">
    <div class="alert alert-info border-0 mb-4 py-2">
      <small><i class="fas fa-info-circle me-1"></i>Complete la información de asignación del personal seleccionado</small>
    </div>

    <!-- Sección: Información Básica -->
    <div class="mb-4">
      <h6 class="text-muted small text-uppercase mb-3 fw-semibold">
        <i class="fas fa-building me-2"></i>Información Básica
      </h6>
      
      <div class="mb-3">
        <label class="form-label fw-medium small mb-1">Empresa</label>
        <input 
          type="text" 
          class="form-control form-control-sm bg-light" 
          [value]="'Empresa ID: ' + selectedPersonal.empresaId" 
          disabled
        >
      </div>

      <div class="mb-3">
        <div class="form-check form-switch">
          <input 
            class="form-check-input" 
            type="checkbox" 
            role="switch"
            [(ngModel)]="selectedPersonal.marcaAsistencia"
            id="checkMarcaAsistencia"
          >
          <label class="form-check-label fw-medium small" for="checkMarcaAsistencia">
            <i class="fas fa-clock me-1"></i>Habilitar marca de asistencia
          </label>
        </div>
        <small class="text-muted ms-4">Permite registrar entrada y salida del personal</small>
      </div>
    </div>

    <hr class="my-4">

    <!-- Sección: Asignaciones Laborales -->
    <div class="mb-4">
      <h6 class="text-muted small text-uppercase mb-3 fw-semibold">
        <i class="fas fa-briefcase me-2"></i>Asignaciones Laborales
      </h6>

      <div class="row g-3">
        <div class="col-12">
          <label class="form-label fw-medium small mb-1">
            Contrato
            <span class="text-danger">*</span>
          </label>
          <dx-select-box
            [(value)]="selectedPersonal.contratoCabeceraId"
            [dataSource]="contratos"
            displayExpr="nombre"
            valueExpr="id"
            [showClearButton]="true"
            placeholder="Seleccione un tipo de contrato"
          >
          </dx-select-box>
        </div>

        <div class="col-12">
          <label class="form-label fw-medium small mb-1">
            Horario
            <span class="text-danger">*</span>
          </label>
          <dx-select-box
            [items]="horarios"
            displayExpr="nombre"
            valueExpr="id"
            [(value)]="selectedHorarioId"
            placeholder="Seleccione un horario de trabajo"
          >
          </dx-select-box>
        </div>

        <div class="col-12">
          <label class="form-label fw-medium small mb-1">
            Superior Inmediato
            <span class="text-muted ms-1">(Opcional)</span>
          </label>
          <dx-select-box
            [(value)]="selectedPersonal.superiorId"
            [items]="superiores"
            displayExpr="nombreCompleto"
            valueExpr="id"
            [showClearButton]="true"
            [searchEnabled]="true"
            placeholder="Buscar y seleccionar superior jerárquico"
          >
          </dx-select-box>
        </div>

        <div class="col-12">
          <label class="form-label fw-medium small mb-1">
            Estado del Personal
            <span class="text-danger">*</span>
          </label>
          <dx-select-box
            [(value)]="selectedPersonal.personalEstadoId"
            [items]="estados"
            displayExpr="nombre"
            valueExpr="id"
            placeholder="Seleccione el estado laboral"
          >
          </dx-select-box>
        </div>
      </div>
    </div>

    <hr class="my-4">

    <!-- Sección: Configuraciones Avanzadas -->
    <div class="mb-4">
      <h6 class="text-muted small text-uppercase mb-3 fw-semibold">
        <i class="fas fa-cog me-2"></i>Configuraciones Avanzadas
      </h6>

      <div class="row g-3">
        <div class="col-12">
          <label class="form-label fw-medium small mb-1">
            Política de Registro de Asistencia
            <span class="text-muted ms-1">(Opcional)</span>
          </label>
          <dx-select-box
            [(value)]="selectedPersonal.registroAsistenciaPoliticaId"
            [items]="politicasRegistro"
            displayExpr="nombre"
            valueExpr="id"
            [showClearButton]="true"
            [searchEnabled]="true"
            placeholder="Seleccione una política de asistencia"
          >
            <div *dxTemplate="let data of 'item'">
              <div class="py-1">
                <div class="fw-medium">{{ data.nombre }}</div>
                <small class="text-muted d-block">{{ data.nombreCorto }} - {{ data.descripcion }}</small>
              </div>
            </div>
          </dx-select-box>
          <small class="text-muted d-block mt-1">
            <i class="fas fa-info-circle me-1"></i>Define reglas de tardanzas y tiempo extra
          </small>
        </div>

        <div class="col-12">
          <label class="form-label fw-medium small mb-1">
            Usuario del Sistema
            <span class="text-muted ms-1">(Opcional)</span>
          </label>
          <dx-select-box
            [(value)]="selectedPersonal.usuarioId"
            [items]="usuarios"
            displayExpr="displayName"
            valueExpr="id"
            [showClearButton]="true"
            [searchEnabled]="true"
            placeholder="Buscar por email del usuario"
          >
            <div *dxTemplate="let data of 'item'">
              <div class="py-1">
                <div class="fw-medium">
                  <i class="fas fa-user-circle me-2 text-primary"></i>{{ data.userName }}
                </div>
                <small class="text-muted" *ngIf="data.email !== data.userName">{{ data.email }}</small>
              </div>
            </div>
          </dx-select-box>
          <small class="text-muted d-block mt-1">
            <i class="fas fa-info-circle me-1"></i>Vincula al personal con una cuenta del sistema
          </small>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
      <button 
        class="btn btn-secondary btn-sm px-4" 
        (click)="popupVisible=false"
      >
        <i class="fas fa-times me-1"></i>Cancelar
      </button>
      <button 
        class="btn btn-primary btn-sm px-4" 
        (click)="guardarAsignacion()"
      >
        <i class="fas fa-check me-1"></i>Guardar Cambios
      </button>
    </div>
  </div>
</dx-popup>

<!-- Popup Subida Masiva -->
<dx-popup
  [(visible)]="popupSubidaMasivaVisible"
  [width]="600"
  [height]="'auto'"
  [showTitle]="true"
  title="Subida Masiva de Personal"
  [dragEnabled]="true"
  [closeOnOutsideClick]="false"
  [showCloseButton]="true"
>
  <div class="p-4">
    <div class="alert alert-info border-0 mb-4 py-2">
      <small>
        <i class="fas fa-info-circle me-1"></i>
        Sube un archivo Excel (.xlsx) con los datos del personal. 
        Los campos requeridos son: APELLIDO/NOMBRES, NRO DOCUMENTO, SEXO, EMAIL, TELEFONO, FEC.NACIMIENTO
      </small>
    </div>

    <div class="mb-4">
      <label class="form-label fw-medium small mb-2">
        Seleccionar Archivo Excel
        <span class="text-danger">*</span>
      </label>
      <input 
        type="file" 
        class="form-control" 
        accept=".xlsx,.xls"
        (change)="onFileSelected($event)"
        #fileInput
      >
      <small class="text-muted d-block mt-1">
        <i class="fas fa-file-excel me-1"></i>
        Formatos permitidos: .xlsx, .xls
      </small>
    </div>

    <div *ngIf="archivoSeleccionado" class="alert alert-success py-2 mb-3">
      <small>
        <i class="fas fa-check-circle me-1"></i>
        Archivo seleccionado: <strong>{{ archivoSeleccionado.name }}</strong>
      </small>
    </div>

    <div *ngIf="registrosProcesados.length > 0" class="mb-3">
      <h6 class="fw-semibold mb-2">Resumen de procesamiento:</h6>
      <div class="alert alert-light border py-2">
        <div class="d-flex justify-content-between mb-1">
          <small>Total registros:</small>
          <strong>{{ registrosProcesados.length }}</strong>
        </div>
        <div class="d-flex justify-content-between mb-1 text-success">
          <small>Exitosos:</small>
          <strong>{{ registrosExitosos }}</strong>
        </div>
        <div class="d-flex justify-content-between text-danger">
          <small>Fallidos:</small>
          <strong>{{ registrosFallidos }}</strong>
        </div>
      </div>
    </div>

    <div *ngIf="erroresProcesamiento.length > 0" class="mb-3" style="max-height: 200px; overflow-y: auto;">
      <h6 class="fw-semibold mb-2 text-danger">
        <i class="fas fa-exclamation-triangle me-1"></i>Errores encontrados:
      </h6>
      <div class="alert alert-danger py-1 mb-1" *ngFor="let error of erroresProcesamiento">
        <small>{{ error }}</small>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
      <button 
        class="btn btn-secondary btn-sm px-4" 
        (click)="cerrarSubidaMasiva()"
        [disabled]="procesandoArchivo"
      >
        <i class="fas fa-times me-1"></i>Cancelar
      </button>
      <button 
        class="btn btn-primary btn-sm px-4" 
        (click)="procesarArchivoExcel()"
        [disabled]="!archivoSeleccionado || procesandoArchivo"
      >
        <i class="fas fa-upload me-1"></i>
        {{ procesandoArchivo ? 'Procesando...' : 'Procesar Archivo' }}
      </button>
    </div>
  </div>
</dx-popup>