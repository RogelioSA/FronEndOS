<div class="container-fluid">
    <div class="row g-1 mt-2 mb-4">
      <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>
            <i class="bi bi-clock-history me-2"></i>
            Mis Registros de Asistencia
          </h3>
          
          <!-- Navegación de mes -->
          <div class="d-flex align-items-center gap-3">
            <button 
              class="btn btn-outline-primary btn-sm" 
              (click)="cambiarMes(-1)"
            >
              <i class="bi bi-chevron-left"></i> Anterior
            </button>
            
            <h5 class="mb-0 text-capitalize fw-bold">{{ mesActual }}</h5>
            
            <button 
              class="btn btn-outline-primary btn-sm" 
              (click)="cambiarMes(1)"
            >
              Siguiente <i class="bi bi-chevron-right"></i>
            </button>
          </div>
        </div>
  
        <!-- Tarjetas de estadísticas -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card shadow-sm">
              <div class="card-body text-center">
                <i class="bi bi-list-check fs-1 text-primary mb-2"></i>
                <h6 class="card-title text-muted">Total de Registros</h6>
                <h2 class="text-primary mb-0">{{ totalRegistros }}</h2>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm">
              <div class="card-body text-center">
                <i class="bi bi-box-arrow-in-right fs-1 text-success mb-2"></i>
                <h6 class="card-title text-muted">Entradas</h6>
                <h2 class="text-success mb-0">{{ registrosEntrada }}</h2>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm">
              <div class="card-body text-center">
                <i class="bi bi-box-arrow-right fs-1 text-danger mb-2"></i>
                <h6 class="card-title text-muted">Salidas</h6>
                <h2 class="text-danger mb-0">{{ registrosSalida }}</h2>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm border-warning">
              <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle fs-1 text-warning mb-2"></i>
                <h6 class="card-title text-muted">Tardanzas</h6>
                <h2 class="text-warning mb-0">{{ totalTardanzas }}</h2>
                <small class="text-muted">{{ minutosAcumulados }} min</small>
              </div>
            </div>
          </div>
        </div>
  
        <!-- Tabla de registros -->
        <div class="card shadow-sm">
          <div class="card-header bg-white">
            <h5 class="mb-0">
              <i class="bi bi-table me-2"></i>
              Detalle de Marcaciones
            </h5>
          </div>
          <div class="card-body p-0">
            <dx-data-grid
              id="gridContainer"
              [dataSource]="registrosAsistencia"
              keyExpr="id"
              [showBorders]="true"
              [columnHidingEnabled]="true"
              [rowAlternationEnabled]="true"
              [showColumnLines]="true"
              [showRowLines]="true"
              [allowColumnResizing]="true"
              [width]="'100%'"
            >
              <dxo-paging [pageSize]="15"></dxo-paging>
              <dxo-pager
                [visible]="true"
                [showPageSizeSelector]="true"
                [allowedPageSizes]="[15, 25, 50, 100]"
                [showInfo]="true"
              ></dxo-pager>
  
              <dxo-filter-row [visible]="true"></dxo-filter-row>
              <dxo-header-filter [visible]="true"></dxo-header-filter>
              <dxo-search-panel [visible]="true" placeholder="Buscar..."></dxo-search-panel>
  
              <dxi-column 
                dataField="fecha" 
                caption="Fecha/Hora Marcación"
                [customizeText]="formatearFechaHora"
                sortOrder="desc"
              ></dxi-column>
  
              <dxi-column 
                dataField="fechaJornal" 
                caption="Fecha Jornal"
                [customizeText]="formatearSoloFecha"
              ></dxi-column>
  
              <dxi-column 
                dataField="tipoEvento" 
                caption="Tipo Evento"
                alignment="center"
                [calculateCellValue]="calcularCellValue"
                cellTemplate="tipoEventoTemplate"
              ></dxi-column>
  
              <dxi-column 
                caption="Hora Programada"
                alignment="center"
                [calculateCellValue]="calcularHoraProgramada"
              ></dxi-column>
  
              <dxi-column 
                dataField="esTardanza" 
                caption="Tardanza"
                dataType="boolean"
                alignment="center"
                cellTemplate="tardanzaTemplate"
              ></dxi-column>
  
              <dxi-column 
                dataField="diferenciaMinutos" 
                caption="Diferencia (min)"
                alignment="center"
                cellTemplate="diferenciaTemplate"
              ></dxi-column>
  
              <dxi-column 
                type="buttons" 
                [width]="80" 
                caption="Ubicación"
                [fixed]="true"
                fixedPosition="right"
              >
                <dxi-button
                  icon="map"
                  hint="Ver ubicación en el mapa"
                  [onClick]="mostrarMapa"
                ></dxi-button>
              </dxi-column>
  
              <!-- Templates -->
              <div *dxTemplate="let cell of 'tipoEventoTemplate'">
                <span [class]="'badge bg-' + obtenerColorTipoEvento(cell.data.tipoEvento)">
                  {{ obtenerNombreTipoEvento(cell.data.tipoEvento) }}
                </span>
              </div>
  
              <div *dxTemplate="let cell of 'tardanzaTemplate'">
                <span *ngIf="cell.data.esTardanza" class="badge bg-warning">
                  <i class="bi bi-exclamation-triangle"></i> Sí
                </span>
                <span *ngIf="!cell.data.esTardanza" class="badge bg-success">
                  <i class="bi bi-check-circle"></i> No
                </span>
              </div>
  
              <div *dxTemplate="let cell of 'diferenciaTemplate'">
                <span 
                  *ngIf="cell.data.diferenciaMinutos > 0" 
                  [class]="'badge ' + (cell.data.esTardanza ? 'bg-danger' : 'bg-info')"
                >
                  {{ cell.data.diferenciaMinutos }} min
                </span>
                <span *ngIf="cell.data.diferenciaMinutos === 0" class="badge bg-success">
                  A tiempo
                </span>
              </div>
            </dx-data-grid>
          </div>
        </div>
  
        <!-- Modal del Mapa -->
        <div *ngIf="mostrarModalMapa" class="modal-backdrop" (click)="cerrarMapa()">
          <div class="map-card" (click)="$event.stopPropagation()">
            <div class="map-card-header">
              <h5>
                <i class="bi bi-geo-alt-fill me-2"></i>
                Ubicación de Marcación
              </h5>
              <button class="btn-close" (click)="cerrarMapa()">×</button>
            </div>
            <div class="map-card-body">
              <div class="coordinates-info mb-3">
                <div class="row">
                  <div class="col-6">
                    <strong>Latitud:</strong> {{ coordenadasSeleccionadas.latitud || 'N/A' }}
                  </div>
                  <div class="col-6">
                    <strong>Longitud:</strong> {{ coordenadasSeleccionadas.longitud || 'N/A' }}
                  </div>
                </div>
              </div>
              <div id="map" style="height: 400px; width: 100%;"></div>
            </div>
          </div>
        </div>
  
        <block-ui></block-ui>
      </div>
    </div>
  </div>